// Using compat libraries for simplicity in service worker environment
importScripts('https://www.gstatic.com/firebasejs/11.12.2/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/11.12.2/firebase-messaging-compat.js');

// This script is dynamically generated by a Next.js route to provide the config
importScripts('/firebase-config.js');

if (self.firebaseConfig && self.firebaseConfig.projectId) {
  firebase.initializeApp(self.firebaseConfig);
  const messaging = firebase.messaging();
  
  messaging.onBackgroundMessage((payload) => {
    console.log('[firebase-messaging-sw.js] Received background message ', payload);

    // The payload contains the notification data sent from the server
    const notificationTitle = payload.notification.title;
    const notificationOptions = {
      body: payload.notification.body,
      icon: payload.notification.icon || '/icon-192x192.png',
      // Adding a tag to prevent multiple notifications from stacking up
      tag: 'prayer-notification' 
    };

    // Use the Service Worker's registration to show the notification
    return self.registration.showNotification(notificationTitle, notificationOptions);
  });
} else {
    console.error('Firebase config not found in service worker.');
}
